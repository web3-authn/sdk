name: ci

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies (workspace)
        run: pnpm install --no-frozen-lockfile

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Add wasm32 target
        run: rustup target add wasm32-unknown-unknown

      - name: Install wasm-pack
        run: |
          curl -sSf https://rustwasm.github.io/wasm-pack/installer/init.sh | sh

      - name: Setup Bun (for worker bundling)
        uses: oven-sh/setup-bun@v2

      - name: Install Playwright (Chromium + deps)
        run: npx playwright install --with-deps chromium

      - name: Type-check SDK
        run: pnpm --filter @web3authn/passkey type-check

      - name: Build SDK
        run: pnpm --filter @web3authn/passkey build

      - name: Run wallet-iframe unit tests
        env:
          USE_RELAY_SERVER: '1'
        run: pnpm --filter @web3authn/passkey test:wallet-iframe

      - name: Run lit-components unit tests
        env:
          USE_RELAY_SERVER: '1'
        run: pnpm --filter @web3authn/passkey test:lit-components
