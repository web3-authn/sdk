# Log Reduction Plan (critical logs only)

Goals
- Reduce console noise across parent app, wallet iframe, and workers.
- Emit only critical signals required to triage failures and security issues.
- Make all non‑critical/verbose logs opt‑in via scoped debug flags.

Scope (primary sources)
- Client (parent): `passkey-sdk/src/core/WalletIframe/client/*`
  - `IframeTransport.ts`, `router.ts`, `overlay-controller.ts`
- Wallet host: `passkey-sdk/src/core/WalletIframe/host/*`
  - `wallet-iframe-host.ts`, Lit components boot paths
- Workers: `passkey-sdk/src/core/*.worker.ts`, `src/core/wasmLoader.ts`
- React SDK surface logs (context/provider): `passkey-sdk/src/react/*`

Strategy
- Centralize logging behind a tiny logger utility with levels and scopes.
  - Levels: `error`, `warn`, `info`, `debug`, `trace`.
  - Scopes: `transport`, `router`, `host`, `worker:signer`, `worker:vrf`, `wasm`, `ui`, `prefs`.
  - Runtime control via env/flags: `W3A_LOG_LEVEL`, `W3A_DEBUG_SCOPES` (CSV), plus URL param `?w3aDebug=router,transport` and `localStorage.W3A_DEBUG_SCOPES` fallback.
- Default level = `error` in production, `warn` in dev. Gate all `info/debug/trace` behind flags.
- Deduplicate/throttle repeating lines (e.g., worker creation, wasm path resolution) using a keyed `once()` and `rateLimit(key, windowMs)` helpers.
- Emit only critical logs by default (see Keep list). Demote everything else to `debug` or remove entirely.
- Ensure build-time stripping for `debug/trace` (e.g., Vite/Rolldown define to no‑ops in production bundles).

Keep (critical signals only)
- Handshake/connection failures
  - READY timeout or adoption failure (transport/router) → error.
  - Iframe mount failure or invalid origin/service path → error.
- Security/permissions blockers
  - COOP/COEP or Permissions‑Policy preventing operation → error/warn.
  - WebAuthn/TouchID fallback cannot proceed (user‑blocking) → warn/error.
- Worker/WASM criticals
  - Worker spawn failure, crash, or retry exhaustion → error.
  - WASM fetch/instantiate failure → error.
- Configuration criticals
  - Missing/invalid relayer/network/contract required for current flow → error/warn.
- Unexpected exceptions
  - Any uncaught error surfaced via router/host flows → error with context.

Demote or remove
- All non‑blocking info/debug banners (e.g., assets base set, resolved wasm URL, routine prefs) → `debug` or remove.
- Repeating worker spawn messages → `debug` with de‑dup.
- Iframe mount success banner → `debug`.
- Lit dev mode warning is external; cannot remove — leave as is.

Implementation Plan
1) Introduce logger utility (non‑breaking)
   - File: `passkey-sdk/src/utils/logger.ts`
   - API: `logger(level, scope).log(...args)`, plus sugar: `log.debug(scope, …)`.
   - Read flags from `globalThis.__W3A_DEBUG__`, `import.meta.env`, URL, and `localStorage`.
   - Provide `once(key, fn)` and `rateLimit(key, windowMs, fn)` helpers.

2) Gate existing logs
   - Transport/router: convert `console.*` to `log.info/warn/error` and demote noisy lines to `debug`.
     - Files: `client/IframeTransport.ts`, `client/router.ts`, `client/overlay-controller.ts`.
   - Host: gate setup/info to `info` (once), demote boot chatter to `debug`.
     - File: `host/wallet-iframe-host.ts`.
   - Workers/wasm loader: keep failures as `error`; demote path resolution and repeated spawns to `debug` with `once()`/`rateLimit()`.
     - Files: `core/web3authn-signer.worker.ts`, `core/web3authn-vrf.worker.ts`, `core/wasmLoader.ts`.
   - React provider/prefs: keep high‑level state changes at `info`; demote defaults and routine flows to `debug`.
     - Files: `react/context/*`, `core/WebAuthnManager/userPreferences.ts`.

3) Production stripping
   - Use bundler define to drop `info/debug/trace` in prod bundles:
     - Vite/Rolldown define: `__W3A_PROD__`, transform or replace `log.info/log.debug` with no‑ops via plugin.

4) Scopes and defaults
   - Default `warn` in dev; `error` in prod.
   - Allow enabling per‑scope via `W3A_DEBUG_SCOPES=router,transport,worker:signer`.
   - Parse `?w3aDebug=…` URL param to override at runtime (handy for Pages).

5) Test/verify
   - Manual: run examples, toggle `?w3aDebug=` and confirm reduced baseline logs.
   - Ensure critical errors/timeouts still surface at `error/warn`.
   - E2E: assert console doesn’t contain gated phrases unless debug enabled.

6) Rollout
   - Phase 1: Introduce logger + gate in transport/router/workers (largest noise).
   - Phase 2: Host + React provider/prefs.
   - Phase 3: Sweep minor modules (utils) and documentation update.

Acceptance Criteria
- Baseline dev console shows only critical errors and blocking warnings.
- Only the “Keep (critical)” list is visible by default; others appear only with debug scopes enabled.
- Production bundles omit `info/debug/trace` entirely.
- No functional/logical regressions; errors remain actionable with context.

Appendix: Example usage
```ts
import { log, once } from '@/utils/logger';

log.info('transport', 'CONNECT→READY handshake start');
once('wasm-url:vrf', () => log.info('wasm', 'VRF wasm URL', url.toString()));
log.debug('worker:signer', 'spawn', { src: workerUrl });
log.error('router', 'READY timeout', { elapsedMs });
```

